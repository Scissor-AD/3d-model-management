<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>NYPL Point Cloud</title>
  <link rel="preconnect" href="https://3dmodelmanagement.github.io" crossorigin>
  <link rel="dns-prefetch" href="https://3dmodelmanagement.github.io">
  <link rel="preload" href="https://3dmodelmanagement.github.io/nypl/libs/three.js/build/three.min.js" as="script">
  <link rel="preload" href="https://3dmodelmanagement.github.io/nypl/libs/potree/potree.js" as="script">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/potree/potree.css">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/jquery-ui/jquery-ui.min.css">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/perfect-scrollbar/css/perfect-scrollbar.css">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/openlayers3/ol.css">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/spectrum/spectrum.css">
  <link rel="stylesheet" type="text/css" href="https://3dmodelmanagement.github.io/nypl/libs/jstree/themes/mixed/style.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #FFFFFF; }
    #potree_sidebar_container { display: none !important; }
    .potree_container { position: absolute; width: 100%; height: 100%; left: 0; top: 0; }
    #potree_render_area { background: #FFFFFF !important; width: 100% !important; left: 0 !important; }
    #potree_render_area canvas { background: transparent !important; }
    .potree_info_text, #potree_description, .annotation, #potree_quick_buttons,
    #potree_map_toggle, .potree_sidebar_brand, #sidebar_root,
    #potree_menu_toggle, .potree_menu_toggle,
    #potree_toolbar, .potree_toolbar,
    .dg, .dg.main,
    #message_listing, .pv-console-message { display: none !important; }
  </style>
</head>
<body>
  <div class="potree_container">
    <div id="potree_render_area"></div>
    <div id="potree_sidebar_container"></div>
  </div>

  <script>
    // Cross-origin Worker fix: Potree creates Workers pointing to scripts on
    // GitHub Pages, which the browser blocks as cross-origin. Classic workers
    // allow importScripts() across origins, so we proxy through a same-origin
    // blob that delegates via importScripts().
    (function () {
      var NativeWorker = window.Worker;
      window.Worker = function (url, opts) {
        try {
          return new NativeWorker(url, opts);
        } catch (e) {
          var absUrl = new URL(url, window.location.href).href;
          var blob = new Blob(
            ['importScripts("' + absUrl + '");'],
            { type: "application/javascript" }
          );
          return new NativeWorker(URL.createObjectURL(blob), opts);
        }
      };
      window.Worker.prototype = NativeWorker.prototype;
    })();

    var BASE = "https://3dmodelmanagement.github.io/nypl/libs/";

    var scripts = [
      BASE + "jquery/jquery-3.1.1.min.js",
      BASE + "spectrum/spectrum.js",
      BASE + "perfect-scrollbar/js/perfect-scrollbar.jquery.js",
      BASE + "jquery-ui/jquery-ui.min.js",
      BASE + "three.js/build/three.min.js",
      BASE + "other/BinaryHeap.js",
      BASE + "tween/tween.min.js",
      BASE + "d3/d3.js",
      BASE + "proj4/proj4.js",
      BASE + "openlayers3/ol.js",
      BASE + "i18next/i18next.js",
      BASE + "jstree/jstree.js",
      BASE + "potree/potree.js",
      BASE + "plasio/js/laslaz.js"
    ];

    var loaded = 0;
    function loadNext() {
      if (loaded >= scripts.length) {
        initViewer();
        return;
      }
      var s = document.createElement("script");
      s.src = scripts[loaded];
      s.onload = function () { loaded++; loadNext(); };
      s.onerror = function () { loaded++; loadNext(); };
      document.body.appendChild(s);
    }
    loadNext();

    function initViewer() {
      window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

      viewer.setFOV(60);
      viewer.setPointBudget(2 * 1000 * 1000);
      viewer.setBackground("white");
      viewer.setEDLEnabled(true);
      viewer.setEDLRadius(1.4);
      viewer.setEDLStrength(0.4);
      viewer.setDescription("");
      viewer.setLengthUnit("ft");

      viewer.loadGUI(function () {
        viewer.setLanguage("en");
        viewer.toggleSidebar();
      });

      window.parent.postMessage({ type: "potree-viewer-ready" }, "*");

      Potree.loadPointCloud(
        "https://3dmodelmanagement.github.io/nypl/pointclouds/nypl_main_hall/cloud.js",
        "nypl_main_hall",
        function (e) {
          var pointcloud = e.pointcloud;
          var material = pointcloud.material;

          viewer.scene.addPointCloud(pointcloud);

          material.pointColorType = Potree.PointColorType.RGB;
          material.size = 1;
          material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
          material.shape = Potree.PointShape.SQUARE;

          viewer.fitToScreen();

          window.parent.postMessage({ type: "potree-loaded" }, "*");
        }
      );
    }
  </script>
</body>
</html>
